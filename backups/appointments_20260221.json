export const runtime = 'edge';

import type { Metadata } from "next";
import { cookies } from "next/headers";
import site from "@/content/site.json";
import AdminAppointments from "@/components/AdminAppointments";
import AdminLoginForm from "@/components/AdminLoginForm";
import AdminLogoutButton from "@/components/AdminLogoutButton";
import { ADMIN_SESSION_COOKIE, createAdminSessionValue, isValidAdminSession, verifyAdminPassword } from "@/lib/admin-auth";
import { NextResponse } from "next/server";

export const dynamic = "force-dynamic";

export const metadata: Metadata = {
  title: `${site.pages.admin.title} | ${site.brand.name}`,
  description: site.pages.admin.description,
  robots: {
    index: false,
    follow: false
  }
};

export async function POST(request: Request) {
  const payload = await request.json();

  if (!payload || typeof payload.password !== "string") {
    return NextResponse.json({ error: "INVALID_PAYLOAD" }, { status: 400 });
  }

  if (!verifyAdminPassword(payload.password)) {
    return NextResponse.json({ error: "INVALID_CREDENTIALS" }, { status: 401 });
  }

  const sessionValue = await createAdminSessionValue(payload.password);

  const response = NextResponse.json({ success: true });
  response.cookies.set({
    name: ADMIN_SESSION_COOKIE,
    value: sessionValue,
    httpOnly: true,
    sameSite: "lax",
    secure: process.env.NODE_ENV === "production",
    path: "/",
    maxAge: 60 * 60 * 24 * 7
  });

  return response;
}

export default async function AdminPage() {
  const cookieStore = await cookies();
  const sessionCookie = cookieStore.get(ADMIN_SESSION_COOKIE)?.value;
  const isAuthenticated = await isValidAdminSession(sessionCookie);

  return (
    <>
      <section className="mx-auto w-full max-w-6xl px-4 pb-4 pt-14 md:px-8 md:pt-20">
        <h1 className="font-[family-name:var(--font-display)] text-4xl md:text-5xl">{site.pages.admin.title}</h1>
        <p className="mt-4 max-w-3xl text-muted">{site.pages.admin.description}</p>
      </section>
      {isAuthenticated ? (
        <>
          <section className="mx-auto flex w-full max-w-6xl justify-end px-4 md:px-8">
            <AdminLogoutButton />
          </section>
          <AdminAppointments />
        </>
      ) : (
        <AdminLoginForm />
      )}
    </>
  );
}
